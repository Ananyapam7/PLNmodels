---
title: "PLNmodels: a case study"
subtitle: "The mollusk data set"
author: "PLN team"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["pln.css", default, metropolis, metropolis-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

class: inverse, center, middle

<!-- background-image: url(../../../man/figures/logo.png) -->

# Getting Started

---
# Requirements

## Package PLNmodels and dependencies

For this tutorial, you may preferably install the last release of **PLNmodels** from GitHub:

```{r eval=FALSE, tidy=FALSE}
devtools::install_github("jchiquet/PLNmodels@v7.0.0")
```

Advanced users<sup>1</sup> can install the development version<sup>2</sup> from [Github](https://github.com/jchiquet/PLNmodels)

```{r eval=FALSE, tidy=FALSE}
devtools::install_github('jchiquet/PLNmodels', build_vignettes = TRUE)
```

.footnote[
[1] Linux or Mac/Windows station equipped for building R packages
]
  
## Rstudio IDE

You are recommended to use the [RStudio IDE](https://www.rstudio.com/products/rstudio/).

- Create a new `R` Markdown document from the menu `File -> New File -> R Markdown`

- Click the `Knit` button to compile it or (best) use  Ctrl/⌘ + ⇧ + K

---

# First steps

## Loading the package

Check that the installation process succeeded

```{r}
library(PLNmodels)
packageVersion("PLNmodels")
```

## Finding help and documentation

The [PLNmodels website](https://jchiquet.github.io/PLNmodels/) contains

- the standard package documentation 
- a set of comprehensive vignettes for the top-level functions

all formatted with [**pkgdown**](https://pkgdown.r-lib.org)

---

# Some additional useful packages

The tools provided by the two following libraries will be useful during our analyses.

```{r load tools}
library(tidyverse) # data manipulation
library(corrplot)  # plot of covariance/correlation matrices
```

---

class: inverse, center, middle

# The Mollusk data set

---

# Data overview

The `mollusk` variable is loaded by the function `data()`. 
```{r load mollusk}
data(mollusk)
```

It consists in a list of two data frames

```{r mollusk struct}
str(mollusk, max.level = 1)
```

These two data frames are typical from ecological data sets:

- The `abundance` table contains the counts of 32 species in 163 samples; 
- The `covariate` table contains information about 4  environmental variables.

Have a look at the help page with `?mollusk` to get additional details.

---

# Abundance table (I)

```{r glimpse Abundance}
mollusk$Abundance %>% 
  dplyr::select(1:10) %>% 
  head() %>% DT::datatable(fillContainer = FALSE)
```

---

# Abundance table (II)

```{r glance Abundances, fig.width=12, fig.height=4}
t(log(1 + mollusk$Abundance)) %>% 
  corrplot::corrplot(
    is.corr = FALSE,
    addgrid.col = NA, 
    tl.cex = .5, 
    cl.pos = "n"
  )
```

---

# Covariates

The three first covariates are categorical. The fourth one is numerical.

- `site`: sampling site
- `season`: winter, spring, summer, autumn
- `method`: sampling - wood or string
- `duration`: time of exposure (in week)

```{r covariates summary}
summary(mollusk$Covariate)
```

---

# Data preparation

In **PLNmodels**, data are handled into a single data frame that put together
1. the counts,
1. the potential covariates,
1. the offset that may be used in the models.

--

_Important!_
1. All the species found in the counts table will be used in the model,
2. The formula mechanism of `R` allow you to choose specific covariates or offsets.

--

The helping function `prepare_data` allows you to avoid taking care of cumbersome data manipulation <sup>1</sup>.

```{r prepare data, eval = FALSE}
prepare_data(
  counts     = , # your count table
  covariates = , # your covariates
  offset     = , # the method to compute offset
)
```

.footnote[
[1] variants of `prepare_data` exist for `biom` and `phyloseq` BioConductor formats.
]
---

# Preparing the mollusk data set 

We choose here to consider the total sum of count to build our vector of offsets

```{r preparing mollusc, warning = FALSE}
mollusc <- prepare_data(
    counts = mollusk$Abundance,
    covariates = mollusk$Covariate, 
{{   offset = "TSS" }} # look at other possible choices
  )
```

--

The structure of the final object is a data frame, but with some columns filled with matrices:

```{r structu mollusc}
str(mollusc, max.level = 1)
```

---

class: inverse, center, middle

# Fitting Poisson Lognormal models with *PLN()*

---

# The Poisson Lognormal model (PLN)

The PLN model is a multivariate generalized linear model, where 

- the counts $\mathbf{Y}_i$ are the response variables
- the main effect is due to a linear combination of the covariates $\mathbf{x}_i$
- a vector of offsets $\mathbf{o}_i$ can be specified for each sample.

$$
  \mathbf{Y}_i | \mathbf{Z}_i \sim \mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right), \qquad \mathbf{Z}_i \sim \mathcal{N}({\mathbf{o}_i + \mathbf{x}_i^\top\boldsymbol\Theta},\boldsymbol\Sigma), \\
$$
The unkwown parameters are 
- $\boldsymbol\Theta$, the matrix of regression parameters
- $\boldsymbol\Sigma$, the variance-covariance matrix

--

When all individuals $i=1,\dots,n$ are stacked together, the data matrices available to feed the model are

  - the $n\times p$ matrix of counts  $\mathbf{Y}$
  - the $n\times d$ matrix of design  $\mathbf{X}$
  - the $n\times p$ matrix of offsets $\mathbf{O}$

---

# The PLN function

The `PLN` function works in the same way as `lm`: 

```{r, eval = FALSE}
PLN(formula = , # mandatory
    data    = , # highly recommended
    subset    , # optional  
    weights   , # optional 
    control     # optional
  )
```

- `data` brings the variable to work with
- `formula` specifies how the relation between variables in `data`

  ( $\rightsquigarrow$ _It builds matrices_ $\mathbf{Y},\mathbf{X},\mathbf{O}$)

--

- `subset` is used for subsampling the observations, 
- `weights` is used to weighting the observations, 
- `control` is (mainly) used for tuning the optimization

---

# Simple PLN models on mollusc data (I)

The simplest model we can imagine only has an intercept term:

```{r mollusc PLN, cache = TRUE, results = FALSE}
M00_mollusc <- PLN(Abundance ~ 1, mollusc)
```

`M00_mollusc` is a particular `R` object that comes with a couple methods:

```{r mollusc PLN print}
M00_mollusc
```

---

# Accessing parameters: coefficients and co

```{r simple PLN coeff}
coef(M00_mollusc) %>% head() %>% t() %>% knitr::kable(format = "html")
```

```{r simple PLN others}
M00_mollusc$criteria %>% knitr::kable(format = "html")
```

Try some other fields!

---

# Accessing parameters: covariance

.pull-left[
```{r simple PLN covariance}
corrplot(
  vcov(M00_mollusc),
  is.corr = FALSE, tl.cex = .5
)
```
]

.pull-right[
```{r simple PLN correlation}
corrplot(
  cov2cor(vcov(M00_mollusc)),
  tl.cex = .5
)
```
]

---

# Playing with offsets

Let us try the Total sum of count for offset, and the sampling duration:

```{r simple PLN offsets, results = FALSE}
M01_mollusc <- PLN(Abundance ~ 1 + offset(log(Offset)) , mollusc)
M02_mollusc <- PLN(Abundance ~ 1 + offset(log(duration)), mollusc)
```

We then compare the models regarding their criteria:

```{r}
rbind(
  M00 = M00_mollusc$criteria,
  M01 = M01_mollusc$criteria, 
  M02 = M02_mollusc$criteria
) %>% knitr::kable(format = "html")
```

