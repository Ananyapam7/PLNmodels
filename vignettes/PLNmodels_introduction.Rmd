---
title: "PLNmodels: mathematical background and companion data set"
author: "PLN team"
date: "`r Sys.Date()`"
bibliography: PLNvignettes.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PLNmodels-background}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette provides mathematical insights for all the statistical models used in the package **PLNmodels**. We also give basic description of the `trichoptera` data set, which is used all along the package in the vignettes and the  documentation examples.

## Motivations

In **PLNmodels**, the top-level functions (`PLN`, `PLNPCA`, `PLNLDA`, `PLNnetwork`) are dedicted to several common tasks of multivariate analysis (regression, dimension reduction, clustering, structure inference). Contrary to many standard tools of multivariate analysis (PCA, LDA or Gaussian Graphical Models, see @MKB79), which assume a multivariate Gaussian distribution of the data, the family of models used in **PLNmodels**  -- based on the multivariate Poisson Lognormal (PLN) distribution [@AiH89] -- are specific to tables of counts. Such data are common in many application fields such as ecology (abundance table), or genomics (single cell sequencing). These data often come with some external knowledge (via covariates and offsets) which should be taken into account during the fits.

We first quickly review the PLN model from the mathematical side. In a second time, we present a simple dataset from ecology that fulfills all the characteristics described above.

## Mathematical Background

The multivariate Poisson lognormal model [in short PLN, see @AiH89] is the building block for all the multivariate models found in the **PLNmodels** package. It relates some $p$-dimensional observation vectors $\mathbf{Y}_i$ to some  $p$-dimensional vectors of Gaussian latent variables $\mathbf{Z}_i$ as follows
\begin{equation}
  \label{eq:pln-model}
  \begin{array}{rcl}
  \text{latent space } &   \mathbf{Z}_i \sim \mathcal{N}({\boldsymbol\mu},\boldsymbol\Sigma), \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} &   \mathbf{Y}_i | \mathbf{Z}_i\sim\mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right).
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects and the latent covariance matrix $\boldsymbol\Sigma$ describes the underlying structure of dependence between the $p$ variables.

This model generalizes naturally to a formulation closer to a multivariate generalized linear model, where the main effect is due to a linear combination of $d$ covariates $\mathbf{x}_i$. We also let the possibility to add some offsets for the $d$ variables and in each sample., that is $\mathbf{o}_i$. Hence, model \eqref{eq:pln-model} generalizes to

\begin{equation}
  \label{eq:pln-model-glm}
  \mathbf{Y}_i | \mathbf{Z}_i \sim \mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right), \qquad \mathbf{Z}_i \sim \mathcal{N}({\mathbf{o}_i + \mathbf{x}_i^\top\boldsymbol\Theta},\boldsymbol\Sigma), \\
\end{equation}
where $\boldsymbol\Theta$ is a $d\times p$ matrix of regression parameters. At the end of the day, the data matrices available to feed the model are

  - the $n\times p$ matrix of counts $\mathbf{Y}$
  - the $n\times p$ matrix of covariates $\mathbf{X}$
  - the $n\times p$ matrix of offsets $\mathbf{O}$

## The trichoptera dataset

The trichoptera data set [@trichoptera] is an ecological data set describing abundances of Trichopetera species, accompanied with some meteological factors that may influence the presence their presence (hereafter the _covariates_). It is included in the package:

```{r data_load}
library(PLNmodels)
data(trichoptera)
```

Additional details are available to the user by `?PLNmodels::trichoptera`: `trichoptera` is a data frame including 49 rows (the observations - or trapping nights) and 14 columns: 2 multivariate columns (for counts and offsets) and 12 univariate columns (the covariates).

```{r trichoptera description}
colnames(trichoptera)
```

- The `Abundance` column is a $49 \times 17$ matrix of abundancies (or counts) for each 17 species during the 49 trapping nights ($\mathbf{Y}$ in the mathematical model):

```{r responses_trichoptera}
head(trichoptera$Abundance)
```

- In order to correct for the sampling effort, it is natural to use an offset term for each observation that corresponds to the total counts per night, specified by a $49 \times 17$ matrix of offsets^[Note that the offset term remains the same in a given sample albeit sometimes one might include an offset specific to both the sample and the species.] (matrix $\mathbf{O}$ in  model). The corresponding column is named `TotalCounts` in the data frame: 

```{r offset_trichopera}
head(trichoptera$TotalCounts)
```

- The 12 remaning colums are covariates that can be used to form design matrix $\mathbf{X}$:

```{r covariates_trichoptera}
head(trichoptera[, -c(1,14)])
```

## References
