---
title: "PLNmodels: an R package for analyzing multivariate count data with Poisson Lognormal models"
abstract: |
  In many fields of life science, count data is becoming the standard, like abundance table in ecology and microbiology, or single-cell data in molecular biology. The Poisson lognormal model is a latent model that describes the dependency structure of the data in an underlying Gaussian layer, while the observation layer of the count is Poisson distributed. As such, it offers the flexibility of the multivariate Gaussian distribution while preserving count distributions. <br/>
  In the R package **PLNmodels**, we implement an efficient variational strategy for inferring the standard Poisson lognormal model. We derive a series of model by transposing the classical tools from multivariate analysis, mostly tight to the Gaussian assumption of the data, to count data. **PLNmodels** includes variants for Principal Component Analysis, Discriminant Analysis, sparse inverse covariance estimation _a.k.a._ network inference and more coming, all designed for multivariate count data. <div class='altmetric-embed' data-badge-type='donut' data-doi="10.1007/s11222-010-9191-2"></div>
author:
  - name: Julien Chiquet 
    url: http://julien.cremeriefamily.info
    affiliation: MIA Paris, INRA
    affiliation_url: https://www6.inra.fr/mia-paris
  - name: Mahendra Mariadassou
    url: https://mahendra-mariadassou.github.io/
    affiliation: MaIAGE, INRA
    affiliation_url: http://maiage.jouy.inra.fr/
  - name: StÃ©phane Robin
    url: https://www6.inra.fr/mia-paris/Equipes/Membres/Stephane-Robin
    affiliation: MIA Paris, INRA
    affiliation_url: https://www6.inra.fr/mia-paris
date: "`r Sys.Date()`"
bibliography: PLNvignettes.bib
output: 
  rmarkdown::html_document:
    theme: readable
    highlight: pygments
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    fig_width: 7
    fig_height: 6
    fig_caption: true
    df_print: paged
vignette: >
  %\VignetteIndexEntry{PLNmodels-background}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, rows.print = 5)
```

# Motivations

In many fields of life science, count data is becoming the standard, like abundance table in ecology and microbiology, or single-cell data in molecular biology. Even if not explicitly stated, most of the standard tools of multivariate analysis (Principal component analysis, Linear Discriminant Analysis, multivariate linear regression or Gaussian Graphical Models, see e.g. @MKB79), assume a multivariate Gaussian distribution of the data. The goal of **PLNmodels** is to offer a set of functions to perform the standard tasks of multivariate analysis but with table of counts, thus with non-Gaussian data. For now, the top-level functions found in the package allows the user to perform the following analyses

 - Multivariate Regression (with the function `PLN`)
 - Dimension Reduction via probabilistic Poisson PCA (with the function `PLNPCA`)
 - Discriminant Analysis (with the function `PLNLDA`)
 - Structure Inference and sparse covariance estimation (with the function `PLNnetwork`)

In this article we quickly review the mathematical aspect of the PLN model and its variants. In a second time, we illustrate the use of the top level functions by performing various multivariate analysis on a simple dataset from ecology that fulfills the typical characteristics of count data. 

# Mathematical Background

The multivariate Poisson lognormal model [in short PLN, see @AiH89] is the building block for all the multivariate models found in the **PLNmodels** package. It relates some $p$-dimensional observation vectors $\mathbf{Y}_i$ to some  $p$-dimensional vectors of Gaussian latent variables $\mathbf{Z}_i$ as follows
\begin{equation}
  \label{eq:pln-model}
  \begin{array}{rcl}
  \text{latent space } &   \mathbf{Z}_i \sim \mathcal{N}({\boldsymbol\mu},\boldsymbol\Sigma), \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} &   \mathbf{Y}_i | \mathbf{Z}_i\sim\mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right).
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects and the latent covariance matrix $\boldsymbol\Sigma$ describes the underlying structure of dependence between the $p$ variables. Figure [@fig:geometrical_insight] give insight about the role played by the different layers in the PLN.

```{r geometrical_insight, echo = FALSE, results = "asis", message = FALSE, warning = FALSE, fig.cap = "PLN: geometrical view"}
library(ggplot2)
library(gridExtra)
library(ggplot2)
set.seed(20171110)
x <- rnorm(100)
y <- rnorm(100)
b <- data.frame(x = x + y, y = y) / 1
mu <- 0
##
data.perfect <- as.data.frame((b + matrix(rep(mu, each = length(x)), ncol = 2)))
p.latent <- ggplot(data.perfect, aes(x, y)) + geom_point() + ggtitle(expression(Latent~Space~(Z)))
.rpois <- function(lambda) {
  unlist(lapply(exp(lambda), function(x) {rpois(1, x)}))
}
observation <- as.data.frame(lapply(data.perfect, .rpois))
mapped.parameter <- as.data.frame(lapply(data.perfect, exp))
## segment between mapped and observed data
segment.data <- cbind(mapped.parameter, observation)
names(segment.data) <- c("x", "y", "xend", "yend")
## Mapped parameters
p.mapped <- ggplot(mapped.parameter, aes(x, y)) + geom_point(col = "red") + ggtitle(expression(Observation~Space~(exp(Z))))
## Observations only
obs <- group_by(observation, x, y)
obs <- dplyr::summarize(obs, count = n())
p.observation.only <- ggplot(obs, aes(x, y)) +
  geom_point(aes(size = count)) +
  ggtitle(Observation~Space~(Y)~+'noise') +
  theme(legend.position = c(.95, .95), legend.justification = c(1, 1),
        legend.background = element_rect(color = "transparent"),
        legend.box.background = element_blank())
## Observations and latent parameters
p.observation.mixed <- p.observation.only +
  geom_point(data = mapped.parameter, color = "red", alpha = 0.5) +
  geom_segment(data = segment.data, aes(xend = xend, yend = yend), color = "black", alpha = 0.2) +
  ggtitle(Observation~Space~(Y==P(exp(Z)))~+'noise')
grid.arrange(
  p.latent + labs(x = "species 1", y = "species 2"),
  p.mapped  + labs(x = "species 1", y = "species 2"),
  p.observation.mixed + labs(x = "species 1", y = "species 2"),
               p.observation.only + labs(x = "species 1", y = "species 2"),
               ncol = 2)
cat("{#fig:geometrical_insight}")
```


## Acccounting for covariates and offsets in a GLM-like fashion

Count tables  -- like abundace data -- often come with some external knowledge (via covariates and offsets) which should be taken into account during the fits. To this end, model \eqref{eq:pln-model} generalizes naturally to a formulation closer to a multivariate generalized linear model, where the main effect is due to a linear combination of $d$ covariates $\mathbf{x}_i$. We also let the possibility to add some offsets for the $d$ variables and in each sample., that is $\mathbf{o}_i$. Hence, model \eqref{eq:pln-model} generalizes to

\begin{equation}
  \label{eq:pln-model-glm}
  \mathbf{Y}_i | \mathbf{Z}_i \sim \mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right), \qquad \mathbf{Z}_i \sim \mathcal{N}({\mathbf{o}_i + \mathbf{x}_i^\top\boldsymbol\Theta},\boldsymbol\Sigma), \\
\end{equation}
where $\boldsymbol\Theta$ is a $d\times p$ matrix of regression parameters. When all individuals $i=1,\dots,n$ are stacked together, the data matrices available to feed the model are

  - the $n\times p$ matrix of counts  $\mathbf{Y}$
  - the $n\times p$ matrix of design  $\mathbf{X}$
  - the $n\times p$ matrix of offsets $\mathbf{O}$

### GLM notation {-}

We naturally recourse to the `R` `formulas` system to specified our model. A typical call to a a fitting function in **PLNmodels** uses formulas of the form

```{r formulas general, eval = FALSE}
Y ~ 1 + X1 + X2 + X1:X2 + offset(log(O))
```

where `Y` stands for the matrix of observed counts, `X1` and `X2` are two vector of covariates and `O` is a matrix of offsets with the same dimension as `Y`. Note the use of the `log` function _within_ the `offset` function to specify the offset term, as it is the way with GLM-Poisson family of models.

# Step-by-step analysis of an ecological dataset

## The trichoptera data set

The trichoptera data set [@trichoptera] is an ecological data set describing abundances of Trichopetera species, accompanied with some meteological factors that may influence the presence their presence (hereafter the _covariates_)^[The original version is available in the **ade4** package. We included a different version where we only keep a subset of the original meteorological features, for illutrative purposes]. It is included in the package so that additional details are available to the user by `?PLNmodels::trichoptera`.

```{r data load}
library(PLNmodels)
data(trichoptera)
```

The `trichoptera` data frame includes 49 rows (the observations - or trapping nights) and 9 columns. There are 2 multivariate columns (maxtices of counts and offsets) and 7 univariate columns (vectors of covariates) :

### Table of counts (abundancies) {-}

The `Abundance` column is a $49 \times 17$ matrix of abundancies (or counts) for each 17 species during the 49 trapping nights ($\mathbf{Y}$ in the mathematical model):

```{r responses_trichoptera}
trichoptera$Abundance %>% as.data.frame()
```

### Offsets (sampling effort) {-}

In order to correct for the sampling effort, it is natural to use an offset term for each observation that corresponds to the total counts per night, specified by a $49 \times 17$ matrix of offsets^[Note that the offset term remains the same in a given sample albeit sometimes one might include an offset specific to both the sample and the species.] (matrix $\mathbf{O}$ in  model). The corresponding column is named `TotalCounts` in the data frame: 

```{r offset_trichopera}
trichoptera$TotalCounts %>% as.data.frame()
```

### Covariates (external meteorological effect, groups) {-}

The remaning colums are covariates that can be used to form design matrix $\mathbf{X}$:

```{r covariates_trichoptera}
select(trichoptera, -TotalCounts, -Abundance)
```

# References
