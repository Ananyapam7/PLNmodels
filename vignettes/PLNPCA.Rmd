---
title: "Dimension reduction of multivariate count data with the Poisson PCA"
author: "Julien Chiquet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: article/PLNreferences.bib
link-citations: yes
vignette: >
  %\VignetteIndexEntry{PLNPCA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  rows.print = 5,
  message = FALSE, 
  warning = FALSE)
```

## Preliminaries

This vignette illustrates the basical use of the `PLNPCA` function and the methods accompaning the R6 Classes `PLNPCAfamily` and `PLNPCAfit`.

### Requirements

The packages required for the analysis are **PLNmodels** plus some others for data manipulation and representation:

```{r requirement}
library(tidyverse)
library(rmarkdown)
library(corrplot)
library(PLNmodels)
```

### Data set

We illustrate our point with the trichoptera data set, a full description of which can be found in [the corresponding vignette](Trichoptera.html).

```{r data_load}
data(trichoptera)
```

The `trichoptera` data frame stores a matrix of counts (`trichoptera$Abundance`), a matrix of offsets (`trichoptera$TotalCounts`) and some vectors of covariates (`trichoptera$Wind`, `trichoptera$Temperature`, etc.)

### Mathematical Background

The model available in the package belongs to the family of probabilistic PCA models, where the observation are not necessarily Gaussian.  In particular, we consider that observations are drawn from a Poisson distribution. All mathematical details can be found in @PLNPCA. The model that we use for PCA is a variant of the Poisson Lognormal model detailed in [the vignette](PLN.html). We strongly encourage the reader to have a look at `PLN` prior to `PLNPCA`.

The PLN-PCA model can be written in a hierachical framework where a sample of $p$-dimensional observation vectors $\mathbf{Y}_i$ is related to some  $q$-dimensional vectors of latent variables $\mathbf{W}_i$ as follows
\begin{equation} 
  \label{eq:pca-model}
  \begin{array}{rcl}
    \text{latent space }  & \mathbf{W}_i \quad \text{i.i.d.} & \mathbf{W}_i \sim      \mathcal{N}(\mathbf{0}_q, \mathbf{I}_q)  \\
\text{parameter space } &   \mathbf{Z}_i = {\boldsymbol\mu} + \mathbf{B}^\top \mathbf{W}_i & \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} & Y_{ij} | Z_{ij} \sim \mathcal{P}\left(\exp\{Z_{ij}\}\right)
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects, $\mathbf{B}$ to \emph{rescaled} loadings in the parameter spaces and $\mathbf{W}_i$ to scores of the $i$-th observation in the low-dimensional latent subspace of the parameter space. For more details, have a look at our research paper referenced in the package documentation.

The dimension of the latent space $q$ corresponds to the number of axes in the PCA or, in other words, to the rank of $\mathbf{B}\mathbf{B}^\intercal$.

## Analysis of trichoptera data with a PLNPCA model

In the package, the PLNPCA model is adjusted with the function `PLNPCA`, which we review in this section

### A model with latent main effects for the Trichopetra data set

The model can be fitted with the function `PLNPCA` for a series of values for $q$ as follows:

```{r simple PLNPCA}
models.nocov <- PLNPCA(Abundance ~ 1 + offset(log(TotalCounts)),
                       data = trichoptera, ranks = 1:6)
```

Note the use of the `formula` object to specify the model: the vector $\boldsymbol\mu$ of main effects in the mathematical formulation (one per column species) is specified in the call with the formula `~ 1`.

The `model.nocov` variable is an `R6` object with class `PLNPCAfamily`, which comes with a couple of methods. The most basic is the `show/print` method, which send a very basic summary of the estimation process:

```{r show nocov}
models.nocov
```
Complementary information comes with the `plot` method:
```{r plot nocov, fig.width=7, fig.height=5}
plot(models.nocov)
```

The critetion $J$ represents the variational lower bound of the likelihood: in this case, we can see that it is strictly increasing with the number of axes (or subspace dimension). Also note the (approximated) $R^2$ which is displayed for each value of $q$ (see the paper for details on how ot is computed). Generally, smoothness of these criteria is an good indicator to check that the optimization process went well.

From this plot, we can see that the best model in terms of BIC or ICL is obtained for $q=4$ axes. We may extract the corresponding model with the method `getBestModel("ICL")`. A model with a specific number of axes can be extracted with the `getModel(q)` method. 

```{r model extraction}
myPCA.ICL <- getBestModel(models.nocov, "ICL") # if no criteria is specified, the best BIC is used
myPCA.q3  <- getModel(models.nocov, 3)
```

The variables `myPCA.ICL` and `myPCA.q3` are other `R6Class` objects of class `PLNPCAfit` which in turns owns a couple of methods, mostly for vizualization purposes. The `plot` method provides the individual maps and correlation circles as in usual PCA. If an additional classification exist for the observations -- which is the case here with the available classification of the trapping nights -- , it can be passed as an argument of the function.

```{r map, fig.width=8, fig.height=8}
plot(myPCA.ICL, ind_cols = trichoptera$Group)
```

With our model (and any pPCA model for count data, where model are not necessarily nested), it is important to look at all the axes at the same time, since the model with $q=3$ axes is not included in the model with $q=5$ axes. Indeed, let us vizualize first three axes for the model with $q=5$ (note that we can control the axes which are plotted):

```{r map q3, fig.width=8, fig.height=8}
plot(myPCA.q3, ind_cols = trichoptera$Group)
```

We can see that the maps for axes (1,2) is slightly different for the model with $q=3$ from the one obtained for axes (1,2) in the $q=3$ model. 

Also, percentage of variance must be interpreted with care: it sums to 100% but must be put in perspective with the model $R^2$, giving an approximation of the total percentage of variance explained with the current model.

### A model accounting for meteorological covariates in the Trichopetra data set

An original contribution of our model is to let the possibility of taking into account some covariates in the parameter space. Such a strategy often completly changes the interpretation of PCA. Indeed, the covariates are often responsible for some strong structure in the data. The effect of the covariates should be removed since they are often quite obvious for the analyst and may hide some more important and subtile effects.

Basically, the model with covariates extends the one used in the previous section by modeling the parameter space as follows:

\begin{equation} 
  \mathbf{Z}_i = {\boldsymbol\mu} + {\boldsymbol\Theta} \mathbf{X}_i^\intercal +    \mathbf{B}^\top \mathbf{W}_i, \qquad \mathbf{Z}_i \sim \mathcal{N}({\boldsymbol\mu} + {\boldsymbol\Theta} \mathbf{X}_i^\intercal, \mathbf{B}\mathbf{B}^\top),
\end{equation}

where $\mathbf{X}_i$ is a vector of $d$ covariate for observations $i$. The $p \times d$ matrix  $\boldsymbol\Theta$ entails the associated parameters.

In the case at hand, the covariates corresponds to the meteorological variables. Let us try to introduce some of them in our model, for instance, the minimal temperature, the wind and the average cloudiness This can be done thanks to the model formula:

```{r cov}
models.cov <- PLNPCA(Abundance ~ 1 + offset(log(TotalCounts)) + Temperature + Wind + Cloudiness, data = trichoptera, ranks = 1:6)
```

Again, the best model is obtained for $q=3$ classes.

```{r extraction cov}
models.cov
myPCA.cov <- getBestModel(models.cov, "ICL")
```

The `show/print` method lists a few summary statistics and useful methods / fields.
```{r}
myPCA.cov
```

Suppose that we want to give a closer look to the first two axes. This can be done thanks to the plot method:

```{r map individual, fig.height=7, fig.width=7}
plot(myPCA.cov, map = "individual", ind_cols = trichoptera$Group)
```

```{r map correction, fig.height=7, fig.width=7}
plot(myPCA.cov, map = "variable")
```

### Data structure of a `PLNPCAfit` model

`myPCA.cov` is an object of class `PLNPCAfit` with several fields, in addition to the two plot methods previously mentioned. It also inherits from  the methods of `PLNfit` (see the appropriate vignette). Among the many fields, the most interesting for the end-user are 

- the regression coefficient matrix
```{r}
head(coef(myPCA.cov))
```
- the rotation matrix (in the latent space)
```{r}
head(myPCA.cov$rotation)
```
- the principal components values (or scores)
```{r}
head(myPCA.cov$scores)
```

That is all for now!

## References

