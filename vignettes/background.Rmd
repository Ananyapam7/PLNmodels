---
title: "PLNmodels: motivation and mathematical background"
author: "Julien Chiquet"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PLNbackground}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette describes the mathematical formulation behind the series of statistical models used in the package **PLNmodels**. 

## Motivation

In **PLNmodels**, the top-level functions (`PLN`, `PLNPCA`, `PLNLDA`, `PLNnetwork`) are dedicted to several common tasks in multivariate analysis (regression, dimension reduction, clustering, structure inference). However, while most tools commonly used for performing multivariate analysis (e.g., kmean clustering or standard PCA) assume a multivariate Gaussian distribution of the data, the family of models used in **PLNmodels**  -- based on the multivariate Poisson Lognormal (PLN) dsitribution -- are specific to tables of counts. Such data are common in many application fields such as ecology (abundance table), or genomics (single cell data). These data often comes with some external knowledge (via covariates and offsets) which should be taken into account during the fits. We first review a simple dataset from ecology that fulfills all these characteristics.

### Example: the trichoptera dataset

The trichoptera data set is an ecological data set describing abundances of Trichopetera species, accompanied with some meteological factors that may influence the presence their presence (hereafter the _covariates_). It is included in the package:

```{r data_load}
library(PLNmodels)
data(trichoptera)
```

Additional details are available to the user by  `?PLNmodels::trichoptera`: 
 
The `data.frame` `trichoptera` includes 49 rows (the observations - or trapping nights) and 14 columns. 

```{r trichoptera description}
colnames(trichoptera)
```

The columns are all univariate covariates expect the `Abundance` column, which is a $49 \times 17$ matrix of abundancies for each 17 species during the 49 trapping nights. It corresponds to the matrix $\mathbf{Y}$ in our model: 

```{r responses_trichoptera}
trichoptera$Abundance[1:5, ]
```

It seems natural to use an offset term for each observation that corresponds to the total counts per night, in order to correct for the sampling effort. It can be specified by a $49 \times 17$ matrix of offsets (the matrix $\mathbf{O}$ in our model) 

```{r offset_trichopera}
trichoptera$TotalCounts[1:5, ]
```
Note that the offset term remains the same in a given sample albeit sometimes one might include an offset specific to both the sample and the species.

The matrix $49 \times 12$ entries remaings corresponds to the matrix $\mathbf{X}$ in our model:

```{r covariates_trichoptera}
head(trichoptera[, -c(1,14)])
```

## The multivariate Poisson Lognormal model (the PLN model)

The multivariate Poisson lognormal model (in short PLN) is the building block for all the multivariate models found in the **PLNmodels** package. the PLN model relates some $p$-dimensional observation vectors $\mathbf{Y}_i$ to some  $p$-dimensional vectors of Gaussian latent variables $\mathbf{Z}_i$ as follows
\begin{equation}
  \label{eq:pln-model}
  \begin{array}{rcl}
  \text{latent space } &   \mathbf{Z}_i \sim \mathcal{N}({\boldsymbol\mu},\boldsymbol\Sigma) \\
  \text{observation space } &  Y_{ij} | Z_{ij} \quad \text{indep.} &   \mathbf{Y}_i | \mathbf{Z}_i\sim\mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right)
  \end{array}
\end{equation}

The parameter ${\boldsymbol\mu}$ corresponds to the main effects and the latent covariance matrix $\boldsymbol\Sigma$ describes the underlying structure of dependence between the $p$ variables.

### Extending the PLN model to account for covariates and offsets

This model generalizes naturally to a formulation closer to a multivariate generalize linear model, where the main effect is due to a linear combination of $d$ covariates $\mathbf{x}_i$. We also let the possibility to add some offsets for the $d$ variables and in each sample., that is $\mathbf{o}_i$. Hence, model \eqref{eq:pln-model} generalizes to

\begin{equation}
  \label{eq:pln-model-glm}
  \mathbf{Y}_i | \mathbf{Z}_i \sim \mathcal{P}\left(\exp\{\mathbf{Z}_i\}\right), \qquad \mathbf{Z}_i \sim \mathcal{N}({\mathbf{o}_i + \mathbf{x}_i^\top\boldsymbol\Theta},\boldsymbol\Sigma) \\
\end{equation}
where $\boldsymbol\Theta$ is a $d\times p$ matrix of regression parameters. At the end of the day, the data matrices available to feed the model are

  - the $n\times p$ matrix of counts $\mathbf{Y}$
  - the $n\times p$ matrix of covariates $\mathbf{X}$
  - the $n\times p$ matrix of offsets $\mathbf{O}$

### 

### PLN inference: a variational approach

## Variants of the PLN model

### PLNPCA: a variant for probabilistic Principal component analysis for counts

### PLNLDA: a variant for discriminant analysis  for counts

### PLNnetwork: a variant for sparse inverse covariance estimation

## Reference

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
writeLines(enc2utf8(toBibtex(citation("PLNmodels"))), "PLNmodels.bib", useBytes = TRUE)
```
