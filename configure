#!/bin/bash
# Julien Chiquet (2018-19) mainly stolen from Anticonf scripts by Jeroen Ooms
#
# This script will query 'pkg-config' for the required cflags and ldflags.

PKG_CONFIG_NAME="nlopt"
PKG_DEB_NAME="libnlopt-dev"
PKG_RPM_NAME="NLopt-devel"
PKG_BREW_NAME="nlopt"
PKG_CSW_NAME=""

# Check if pkg-config
pkg-config --version >/dev/null 2>&1
if [ $? -eq 0 ]; then
  NLOPT_LIBS=`pkg-config --libs ${PKG_CONFIG_NAME}`
  NLOPT_FLAG=`pkg-config --cflags ${PKG_CONFIG_NAME}`
  # Check if nlopt is installed
  if [ -z "$NLOPT_LIBS" ]; then
    echo "------------------------- ANTICONF ERROR ---------------------------"
    echo "Configuration failed because $PKG_CONFIG_NAME was not found. Try installing:"
    echo " * deb: sudo apt-get install $PKG_DEB_NAME (Debian, Ubuntu)"
    echo " * rpm: sudo yum install $PKG_RPM_NAME (Fedora, EPEL)"
    echo " * brew: brew install $PKG_RPM_NAME (MacOS with brew)"
    echo " * otherwise: not yet available"
    echo "--------------------------------------------------------------------"
    exit 1;
  fi
else
  echo "------------------------- ANTICONF ERROR ---------------------------"
  echo "Configuration failed because pkg-config is not installed. Try installing: "
  echo " * deb: sudo apt-get install $PKGCONFIG_DEB_NAME (Debian, Ubuntu)"
  echo " * rpm: $PKGCONFIG_RPM_NAME (Fedora, EPEL)"
  echo " * brew: brew install $PKGCONFIG_BREW_NAME (MacOS with brew)"
  echo " * otherwise: not available"
  echo "--------------------------------------------------------------------"
  exit 1;
fi

# For debugging
echo "Using NLOPT_LIBS=$NLOPT_LIBS"
echo "Using NLOPT_FLAG=$NLOPT_FLAG"

# Avoid OpenMP for MAC OS
if [[ "$OSTYPE" == "darwin"* ]]; then
  OPENMP_FLAG=''
else
  OPENMP_FLAG='$(SHLIB_OPENMP_CXXFLAGS)'
fi

# Write to Makevars
sed -e "s|@nlopt_libs@|$NLOPT_LIBS|" -e "s|@nlopt_flag@|$NLOPT_FLAG|" -e "s|@openmp_flag@|$OPENMP_FLAG|" src/Makevars.in > src/Makevars


# Success
exit 0
